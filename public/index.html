<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MediaSync OS v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style> 
        [x-cloak] { display: none !important; }
        .lightbox-open { overflow: hidden; }
        * { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
        html { scroll-behavior: smooth; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 2px; }
        body { overscroll-behavior: none; -webkit-overflow-scrolling: touch; }
        .item-selected { animation: selectPulse 0.2s ease-out; }
        @keyframes selectPulse { 0% { transform: scale(1); } 50% { transform: scale(0.95); } 100% { transform: scale(1); } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .swipe-indicator { width: 40px; height: 4px; background: rgba(255, 255, 255, 0.3); border-radius: 2px; margin: 0 auto; }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-100 min-h-screen pb-20 sm:pb-8" x-data="galleryApp()" x-init="init()">

    <header class="sticky top-0 z-50 bg-zinc-950/95 border-b border-zinc-800 backdrop-blur-lg">
        <div class="px-4 py-3 sm:px-6 sm:py-4">
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <h1 class="text-base sm:text-xl font-black tracking-tighter text-emerald-500 italic">MEDIA_CLOUD_OS</h1>
                    <div class="flex gap-2 items-center mt-0.5">
                        <p class="text-[8px] sm:text-[9px] font-mono text-zinc-500 uppercase" x-text="isDownloading ? 'Downloading...' : 'Cloud Storage Active'"></p>
                        <span class="text-[8px] sm:text-[9px] text-zinc-600" x-text="stats.totalFiles + ' files'"></span>
                    </div>
                </div>
                <button @click="showMenu = !showMenu" class="sm:hidden p-2 -mr-2 active:bg-zinc-900 rounded-lg transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path x-show="!showMenu" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        <path x-show="showMenu" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <div class="hidden sm:flex gap-3">
                    <button @click="downloadAllIndividual()" class="text-[11px] font-bold bg-white text-black px-4 py-2 rounded-lg">DOWNLOAD ALL</button>
                    <button @click="toggleSelectionMode()" class="text-[11px] font-bold bg-zinc-800 px-4 py-2 rounded-lg" x-text="selectionMode ? 'EXIT SELECT' : 'SELECT'"></button>
                </div>
            </div>
        </div>
        <div class="px-4 pb-3 sm:px-6">
            <div class="relative">
                <input type="search" x-model="searchQuery" placeholder="Search cloud media..." class="w-full bg-zinc-900 border border-zinc-800 rounded-lg pl-10 pr-4 py-2.5 text-sm focus:outline-none focus:border-emerald-500 transition">
                <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            </div>
        </div>
    </header>

    <main class="px-4 py-4 sm:px-6 sm:py-8 max-w-7xl mx-auto">
        <template x-for="(group, date) in filteredMedia" :key="date">
            <div class="mb-8">
                <h3 class="text-[10px] font-black text-zinc-400 mb-4 uppercase tracking-widest" x-text="date"></h3>
                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
                    <template x-for="item in group" :key="item.url">
                        <div @click="handleItemClick(item)" 
                             class="relative aspect-square rounded-lg overflow-hidden border-2 transition-all cursor-pointer"
                             :class="isSelected(item) ? 'border-emerald-500 scale-95' : 'border-zinc-900'">
                            <template x-if="item.type === 'image'"><img :src="item.url" class="w-full h-full object-cover" loading="lazy"></template>
                            <template x-if="item.type === 'video'"><video :src="item.url" class="w-full h-full object-cover" muted></video></template>
                            <div x-show="selectionMode" class="absolute top-1.5 right-1.5"><div class="w-5 h-5 rounded-full border-2" :class="isSelected(item) ? 'bg-emerald-500 border-emerald-500' : 'bg-black/50 border-white/30'"></div></div>
                        </div>
                    </template>
                </div>
            </div>
        </template>
    </main>

    <div x-show="selectedItems.length > 0" class="fixed bottom-0 left-0 right-0 z-50 bg-emerald-600 px-4 py-4 slide-up">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <span class="text-sm font-black" x-text="selectedItems.length + ' SELECTED'"></span>
            <div class="flex gap-2">
                <button @click="createGroupFromSelected()" class="bg-black text-white text-xs font-bold px-4 py-2 rounded-lg">SAVE</button>
                <button @click="deleteSelected()" class="bg-red-600 text-white text-xs font-bold px-4 py-2 rounded-lg">DELETE</button>
            </div>
        </div>
    </div>

    <div x-show="lightbox.open" @click.self="closeLightbox()" class="fixed inset-0 bg-black z-[100] flex items-center justify-center">
        <button @click="closeLightbox()" class="absolute top-6 right-6 text-white p-2 z-[110] bg-zinc-900 rounded-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
        <div class="max-w-full max-h-full p-4">
            <template x-if="lightbox.item?.type === 'image'"><img :src="lightbox.item.url" class="max-h-[85vh] object-contain"></template>
            <template x-if="lightbox.item?.type === 'video'"><video :src="lightbox.item.url" controls autoplay class="max-h-[85vh]"></video></template>
        </div>
    </div>

    <script>
        function galleryApp() {
            return {
                groupedMedia: {}, allMediaFlat: [], selectionMode: false, loading: true, searchQuery: '', showMenu: false, stats: { totalFiles: 0 },
                lightbox: { open: false, item: null, index: 0 },
                selectedItems: JSON.parse(localStorage.getItem('selectedItems') || '[]'),
                customGroups: JSON.parse(localStorage.getItem('customGroups') || '[]'),
                adminPassword: localStorage.getItem('adminPassword') || '',

                async init() {
                    this.$watch('selectedItems', val => localStorage.setItem('selectedItems', JSON.stringify(val)));
                    this.$watch('customGroups', val => localStorage.setItem('customGroups', JSON.stringify(val)));
                    await this.fetchMedia();
                    // Vercel Polling (replaces Socket.io)
                    setInterval(() => this.fetchMedia(), 30000);
                },

                async fetchMedia() {
                    try {
                        const res = await fetch('/api/history');
                        const data = await res.json();
                        this.allMediaFlat = data;
                        const groups = {};
                        data.forEach(item => {
                            if (!groups[item.date]) groups[item.date] = [];
                            groups[item.date].push(item);
                        });
                        this.groupedMedia = groups;
                        this.stats.totalFiles = data.length;
                    } catch (e) { console.error("Cloud error"); }
                    finally { this.loading = false; }
                },

                handleItemClick(item) {
                    if (this.selectionMode) {
                        const idx = this.selectedItems.findIndex(i => i.url === item.url);
                        if (idx > -1) this.selectedItems.splice(idx, 1);
                        else this.selectedItems.push(item);
                    } else {
                        this.lightbox.item = item;
                        this.lightbox.open = true;
                    }
                },

                async deleteSelected() {
                    if (!confirm(`Delete ${this.selectedItems.length} items?`)) return;
                    if (!this.adminPassword) {
                        this.adminPassword = prompt('Admin Password:');
                        localStorage.setItem('adminPassword', this.adminPassword);
                    }
                    // Adjusted to match your delete.js handler
                    for (let item of this.selectedItems) {
                        await fetch('/api/delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.adminPassword}` },
                            body: JSON.stringify({ url: item.url, filename: item.filename })
                        });
                    }
                    this.selectedItems = [];
                    await this.fetchMedia();
                },

                get filteredMedia() {
                    if (!this.searchQuery) return this.groupedMedia;
                    const q = this.searchQuery.toLowerCase();
                    const filtered = {};
                    for (let date in this.groupedMedia) {
                        const matches = this.groupedMedia[date].filter(i => i.filename.toLowerCase().includes(q));
                        if (matches.length) filtered[date] = matches;
                    }
                    return filtered;
                },

                isSelected(item) { return this.selectedItems.some(i => i.url === item.url); },
                toggleSelectionMode() { this.selectionMode = !this.selectionMode; if(!this.selectionMode) this.selectedItems = []; },
                closeLightbox() { this.lightbox.open = false; },
                createGroupFromSelected() {
                    const name = prompt("Name:");
                    if (name) { this.customGroups.push({ name, items: [...this.selectedItems] }); this.selectedItems = []; }
                }
            }
        }
    </script>
</body>
</html>